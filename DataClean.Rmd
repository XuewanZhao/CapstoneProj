---
title: "Data Clean"
output: html_notebook
---

This part contains the data cleaning part of capstone project, which is supervised by Prof. Jerzy.

# Data clean process for CRSP
```{r}
# In this part, we input the CRSP quarterly data and reform them into features.
CRSP_ori = readxl::read_excel("D:\\data\\Capstone\\Data\\CRSP_Quarterly_data.xlsx")

CRSP_feature = subset(CRSP_ori,select=c(GVKEY,datadate,fyearq,fqtr))

CRSP_feature$MV = CRSP_ori$cshoq*CRSP_ori$prccq

CRSP_feature$EV = CRSP_feature$MV + CRSP_ori$dlcq + CRSP_ori$dlttq + CRSP_ori$pstkq - CRSP_ori$cheq

CRSP_feature$tax_rate = CRSP_ori$txtq/CRSP_ori$piq

CRSP_ori$CFO = c(NA,diff(CRSP_ori$oancfy, lag=1))
CRSP_feature$CFO2EV = CRSP_ori$CFO + (CRSP_ori$xintq*(1-CRSP_feature$tax_rate))

CRSP_ori$ASSETS = CRSP_ori$ceqq + CRSP_ori$dlcq + CRSP_ori$dlttq + CRSP_ori$pstkq - CRSP_ori$cheq
CRSP_feature$RONA = (CRSP_ori$ibq+(CRSP_ori$xintq*(1-CRSP_feature$tax_rate)))/CRSP_ori$ASSETS

CRSP_ori$EBITDA = CRSP_ori$saleq - CRSP_ori$cogsq - CRSP_ori$xsgaq
CRSP_feature$EBITDA2EV = CRSP_ori$EBITDA/CRSP_feature$EV

CRSP_feature$E2PFY0 = CRSP_ori$ibcomq/CRSP_feature$MV

CRSP_feature$BB2P = (CRSP_ori$dvy + CRSP_ori$prstkcy-CRSP_ori$sstky)/CRSP_feature$MV

CRSP_ori$EQ_REPO = CRSP_ori$prstkcy - CRSP_ori$sstky
CRSP_ori$DEBT_REPO = CRSP_ori$dltry - CRSP_ori$dlcchy - CRSP_ori$dltisy
CRSP_feature$BB2EV = (CRSP_ori$dvy + CRSP_ori$EQ_REPO - CRSP_ori$DEBT_REPO)/CRSP_feature$EV

CRSP_feature$B2P = CRSP_ori$ceqq/CRSP_feature$MV

CRSP_feature$S2EV = CRSP_ori$saleq/CRSP_feature$EV

CRSP_feature$DVY = CRSP_ori$dvy

CRSP_feature$DATE = TransYQtoDate(CRSP_feature$fyearq,CRSP_feature$fqtr)

# We save the features thus we don't need to recalculate it everytime.
writexl::write_xlsx(CRSP_feature, path="D:\\data\\Capstone\\Data\\CRSP_Features.xlsx", col_names=TRUE)
```
# Data clean process for OHLC
```{r}
# Now we prepare the OHLC prices for these stocks.
OHLC_ori = readxl::read_excel("D:\\data\\Capstone\\Data\\OHLCV_v1.xlsx")
temp = as.character(OHLC_ori$DATE)
OHLC_ori$month = as.numeric(substr(temp, start=5,stop=6))
OHLC_ori$day = as.numeric(substr(temp, start=7,stop=8))

OHLC_v1 = subset(OHLC_ori, (OHLC_ori$month %in% c(3,6,9,12))&(OHLC_ori$day>=28))

# Now we wish to pick out the last valid record in 3,6,9,12 month.
OHLC_v1$ym = substr(as.character(OHLC_v1$DATE), start=1,stop=6)

OHLC_final = OHLC_v1 %>%
  group_by(PERMNO) %>%
  group_by(ym) %>%
  top_n(-1,day)

OHLC_final = OHLC_final %>%
  group_by(GVKEY) %>%
  mutate(RET = (c(CLOSE[-(seq(1))], rep(NA, 1))/CLOSE - 1))

# We save the results thus we don't need to recalculate it everytime.
writexl::write_xlsx(OHLC_final, path="D:\\data\\Capstone\\Data\\OHLC_quarter.xlsx", col_names=TRUE)
```
# Data clean process for LinkKey
```{r}
LinkKey = readxl::read_excel("D:\\data\\Capstone\\Data\\LinkKey_v2.xlsx")
LK_v1 = distinct(subset(LinkKey, select=c(gvkey,tic,cusip,LPERMNO)))
names(LK_v1)[names(LK_v1) == 'LPERMNO'] = 'PERMNO'
names(LK_v1)[names(LK_v1) == 'gvkey'] = 'GVKEY'
# We save the results thus we don't need to recalculate it everytime.
writexl::write_xlsx(LK_v1, path="D:\\data\\Capstone\\Data\\LK.xlsx", col_names=TRUE)
```
